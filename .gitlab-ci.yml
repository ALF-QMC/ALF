variables:
  CONFIG_ARGS: ""  # Variable for additional arguments for configure.sh

default:
  tags: [k8s]
  cache:
    key: HDF5-$MACHINE
    untracked: true
    paths:
      - HDF5
    policy: pull

stages:
  - lint
  - build_hdf5
  - build
  - test
  - testbranch
  - memleaks

.build_hdf5_template: &build_hdf5_definition
  stage: build_hdf5
  variables:
    MACHINE: GNU
  needs: []
  script:
    - ls HDF5
    - du -sh HDF5
    - . configure.sh $MACHINE noMPI HDF5
    - du -sh HDF5
  cache:
    key: HDF5-$MACHINE
    untracked: true
    paths:
      - HDF5
    policy: pull-push

.build_template: &build_definition
  stage: build
  variables:
    MACHINE: GNU
    MODE: noMPI
  needs: []
  script:
    - ls HDF5
    - . configure.sh $MACHINE $MODE $CONFIG_ARGS
    - echo $ALF_FC
    - $ALF_FC -v
    - make all

.test_template: &test_definition
  stage: test
  variables:
    MACHINE: GNU
    MODE: noMPI
  needs: []
  script:
    - ls HDF5
    - . configure.sh $MACHINE Devel $MODE $CONFIG_ARGS
    - echo $ALF_FC
    - $ALF_FC -v
    - make all
    - mkdir testsuite/tests
    - cd testsuite/tests
    - cmake ..
    - cmake --build . --target all --config Release
    - ctest -VV -O log.txt
    - cat log.txt | grep "tests passed" | cut -d " " -f 1

#################################################################################

Check_Stopcommands:
  image: git.physik.uni-wuerzburg.de:25812/z03/pdi/debian:bookworm-buildd
  stage: lint
  needs: []
  except:
    changes:
      - .gitignore
      - CITATION
      - README.md
      - license.*
  script:
    - ! grep -irn -e "^\s*error\s*stop" -e "^\s*stop" --include="*.F90" 
      --exclude-dir=Analysis --exclude-dir=HDF5 --exclude-dir=testsuite 
      --exclude-dir=Not\_supported --exclude="runtime\_error\_mod.F90"

prep_test_branch:
  image: git.physik.uni-wuerzburg.de:25812/z03/pdi/debian:bookworm-buildd
  stage: testbranch
  when: manual
  needs: []
  tags:
    - k8s
  script:
    - apt-get update && apt-get install -y python3-yaml
    - ./testsuite/test_branch_generate_config.py
    - cat generated-config.yml
  artifacts:
    paths:
      - generated-config.yml
    expire_in: 1 day

trigger_test_branch:
  stage: testbranch
  needs: [prep_test_branch]
  trigger:
    include:
      - artifact: generated-config.yml
        job: prep_test_branch
    strategy: depend
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID

create_doc:
  image: aergus/latex
  stage: build
  needs: []
  artifacts:
    paths:
      - Documentation/doc.pdf
  script:
    - cd Documentation
    - latexmk -pdf doc.tex

create_doxygen:
  image: git.physik.uni-wuerzburg.de:25812/z03/pdi/debian:buster-clang
  stage: build
  needs: []
  artifacts:
    expire_in: 120 days
    paths:
      - doxygen/*
      - Images/*
  script:
      - apt-get update && apt install -y doxygen graphviz
      - doxygen doxygen/Doxyfile

pages:
  image: git.physik.uni-wuerzburg.de:25812/z03/pdi/debian:buster-clang
  stage: build
  script:
    - apt-get update && apt install -y doxygen graphviz
    - doxygen doxygen/Doxyfile
    - mkdir public
    - mv doxygen/html/* public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'


build_hdf5_GNU-Buster:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/buster
  needs: []
build_hdf5_GNU-Bullseye:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye
  needs: [build_hdf5_GNU-Buster]
build_hdf5_GNU-Bookworm:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bookworm
  needs: [build_hdf5_GNU-Bullseye]

build_hdf5_PGI-21-03:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-pgi-21-03
  needs: []
  variables:
    MACHINE: PGI

build_hdf5_Intel-21:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-intel
  needs: []
  variables:
    MACHINE: Intel
build_hdf5_Intel-Latest:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/intel
  needs: [build_hdf5_Intel-21]
  variables:
    MACHINE: Intel

build_hdf5_IntelLLVM:
  <<: *build_hdf5_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/intel
  needs: []
  variables:
    MACHINE: IntelLLVM


# GNU on Debian Buster

build_GNU-Buster:
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/buster
  <<: *build_definition

tests_GNU-Buster:
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/buster
  <<: *test_definition

# GNU on Debian Bullseye

build_GNU-Bullseye:
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye
  <<: *build_definition

tests_GNU-Bullseye:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye

build_GNU-Bullseye_MPI:
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye
  stage: build
  needs: []
  variables:
    MACHINE: GNU
  script:
    - gfortran -v
    - . configure.sh $MACHINE Devel Tempering $CONFIG_ARGS
    - make all

vlagrind_GNU-Bullseye:
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye
  stage: memleaks
  needs: []
  variables:
    MACHINE: GNU
  script:
      - sudo apt-get update && sudo apt-get install -y valgrind
      - . configure.sh $MACHINE devel serial $CONFIG_ARGS
      - gfortran -v
      - make lib
      - make program
      - cp Prog/ALF.out Scripts_and_Parameters_files/Start
      - cd Scripts_and_Parameters_files/Start
      - cat parameters
      - valgrind --leak-check=full --log-file=vglog.txt ./ALF.out
      - cat vglog.txt
      - grep lost vglog.txt | cut -d":" -f 2 | cut -d " " -f 2 | f=$(cat); echo $(( ${f//$'\n'/+} ))

# GNU on Debian Bookworm

build_GNU-Bookworm:
  <<: *build_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bookworm

tests_GNU-Bookworm:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bookworm


# GNU on Debian Bullseye with OpenBlas

build_GNU-Bullseye_OpenBlas:
  <<: *build_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-openblas

tests_GNU-Bullseye_OpenBlas:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-openblas

# PGI/NVIDIA 21.03 on Debian Bullseye

build_PGI-21-03:
  <<: *build_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-pgi-21-03
  variables:
    MACHINE: PGI
    MODE: noMPI

tests_PGI-21-03:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-pgi-21-03
  variables:
    MACHINE: PGI
    MODE: noMPI

# Intel 21 on Debian Bullseye

build_Intel-21:
  <<: *build_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-intel
  variables:
    MACHINE: Intel
    MODE: noMPI

tests_Intel-21:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/bullseye-intel
  variables:
    MACHINE: Intel
    MODE: noMPI

# Intel with LLVM

build_IntelLLVM:
  <<: *build_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/intel
  variables:
    MACHINE: IntelLLVM
    MODE: noMPI

tests_IntelLLVM:
  <<: *test_definition
  image: git.physik.uni-wuerzburg.de:25812/alf/alf_docker/alf-requirements/intel
  variables:
    MACHINE: IntelLLVM
    MODE: noMPI
